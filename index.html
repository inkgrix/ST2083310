<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthyLife AI – คำนวณ BMI & TDEE</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Prompt -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #FAFAFA;
            color: #2B2B2B;
        }
        /* Custom active state for meal mode buttons */
        .active-mode {
            background-color: #6EBB9B !important;
            color: white !important;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <main class="container mx-auto px-4 py-8 md:py-12 flex-grow">
        <!-- Title Section -->
        <div class="text-center mb-8 md:mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">HealthyLife AI</h1>
            <p class="mt-2 text-gray-600 max-w-xl mx-auto">คำนวณ BMI & TDEE พร้อมแนะนำอาหารอัจฉริยะ</p>
        </div>

        <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
            <!-- Left Column: Calculator -->
            <div class="bg-white p-6 md:p-8 rounded-[20px] shadow-lg space-y-6">
                <h2 class="text-2xl font-bold text-center text-[#6EBB9B]">คำนวณสุขภาพของคุณ</h2>
                <form id="calc-form" class="space-y-4">
                    <div>
                        <label for="gender" class="block text-sm font-medium text-gray-700">เพศ</label>
                        <select id="gender" class="mt-1 w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-[#6EBB9B] focus:border-[#6EBB9B] transition">
                            <option value="male">ชาย</option>
                            <option value="female">หญิง</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="age" class="block text-sm font-medium text-gray-700">อายุ (ปี)</label>
                            <input type="number" id="age" placeholder="เช่น 25" required class="mt-1 w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-[#6EBB9B] focus:border-[#6EBB9B] transition">
                        </div>
                        <div>
                           <label for="weight" class="block text-sm font-medium text-gray-700">น้ำหนัก (กก.)</label>
                           <input type="number" id="weight" placeholder="เช่น 70" required class="mt-1 w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-[#6EBB9B] focus:border-[#6EBB9B] transition">
                        </div>
                    </div>
                    <div>
                        <label for="height" class="block text-sm font-medium text-gray-700">ส่วนสูง (ซม.)</label>
                        <input type="number" id="height" placeholder="เช่น 175" required class="mt-1 w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-[#6EBB9B] focus:border-[#6EBB9B] transition">
                    </div>
                    <div>
                        <label for="activity" class="block text-sm font-medium text-gray-700">ระดับกิจกรรม</label>
                        <select id="activity" class="mt-1 w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-[#6EBB9B] focus:border-[#6EBB9B] transition">
                            <option value="1.2">ไม่ค่อยออกกำลังกาย</option>
                            <option value="1.375">ออกกำลังกายเบา (1-3 วัน/สัปดาห์)</option>
                            <option value="1.55">ออกกำลังกายปานกลาง (3-5 วัน/สัปดาห์)</option>
                            <option value="1.725">ออกกำลังกายหนัก (6-7 วัน/สัปดาห์)</option>
                            <option value="1.9">ออกกำลังกายหนักมาก</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-[#6EBB9B] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#5AA885] transition duration-300 shadow-md">คำนวณเลย</button>
                </form>
                <div id="results-container" class="hidden bg-[#DFF3E8] p-6 rounded-[20px] text-center space-y-3 mt-6">
                    <h3 class="text-xl font-bold text-[#6EBB9B]">ผลลัพธ์ของคุณ</h3>
                    <p id="bmi-result"></p>
                    <p id="bmr-result"></p>
                    <p id="tdee-result" class="font-bold"></p>
                </div>
            </div>

            <!-- Right Column: Meals -->
            <div class="bg-white p-6 md:p-8 rounded-[20px] shadow-lg space-y-6">
                 <h2 class="text-2xl font-bold text-center text-gray-800">เมนูอาหารแนะนำ</h2>
                
                <div id="goal-container" class="hidden">
                    <label for="goal" class="block text-sm font-medium text-gray-700">เป้าหมายของคุณ</label>
                    <select id="goal" class="mt-1 w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-[#6EBB9B] focus:border-[#6EBB9B] transition">
                        <option value="maintain">คงน้ำหนัก</option>
                        <option value="lose">ลดน้ำหนัก (ลด ~400 kcal)</option>
                        <option value="gain">เพิ่มน้ำหนัก/กล้ามเนื้อ (เพิ่ม ~350 kcal)</option>
                    </select>
                </div>

                <div class="flex justify-center gap-2 bg-gray-100 p-1 rounded-lg">
                    <button id="mode-healthy" class="w-full py-2 px-4 rounded-md font-semibold transition active-mode">เฮลตี้</button>
                    <button id="mode-clean" class="w-full py-2 px-4 rounded-md font-semibold transition text-gray-600">คลีน</button>
                </div>
                
                <div id="meals-container" class="space-y-4">
                    <div id="initial-message" class="text-center py-10 text-gray-500">
                        <p>คำนวณค่า TDEE ของคุณก่อน<br>เพื่อรับคำแนะนำเมนูอาหาร</p>
                    </div>
                    <div id="loader" class="hidden text-center py-10">กำลังโหลดเมนูอาหาร...</div>
                    <div id="error-message" class="hidden text-center text-red-500 py-10"></div>
                    <div id="meal-cards-grid" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Meal cards will be inserted here by JavaScript -->
                    </div>
                     <div id="total-calories-container" class="hidden text-center bg-gray-100 p-3 rounded-lg mt-4">
                        <p id="total-calories-text" class="font-bold text-gray-700"></p>
                    </div>
                    <button id="shuffle-btn" class="hidden w-full bg-white border-2 border-[#6EBB9B] text-[#6EBB9B] font-bold py-3 px-4 rounded-lg hover:bg-[#6EBB9B] hover:text-white transition duration-300">สุ่มเมนูใหม่</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center py-6 bg-[#DFF3E8] mt-auto">
        <p class="text-sm text-[#5AA885]">© 2025 HealthyLife AI – เพื่อสุขภาพที่ดีขึ้นของคุณ</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const MEALS_JSON_URL = 'https://raw.githubusercontent.com/inkgrix/ST2083310/main/food_dataset.json';

            // --- DOM ELEMENTS ---
            const calcForm = document.getElementById('calc-form');
            const resultsContainer = document.getElementById('results-container');
            const bmiResultEl = document.getElementById('bmi-result');
            const bmrResultEl = document.getElementById('bmr-result');
            const tdeeResultEl = document.getElementById('tdee-result');
            
            const goalContainer = document.getElementById('goal-container');
            const goalSelect = document.getElementById('goal');
            
            const modeHealthyBtn = document.getElementById('mode-healthy');
            const modeCleanBtn = document.getElementById('mode-clean');
            const shuffleBtn = document.getElementById('shuffle-btn');
            
            const initialMessage = document.getElementById('initial-message');
            const loader = document.getElementById('loader');
            const errorMessage = document.getElementById('error-message');
            const mealCardsGrid = document.getElementById('meal-cards-grid');
            const totalCaloriesContainer = document.getElementById('total-calories-container');
            const totalCaloriesText = document.getElementById('total-calories-text');

            // --- STATE ---
            let allMeals = [];
            let currentMealMode = 'healthy';
            let calculatedTDEE = null;
            let targetCalories = null;
            let currentlyDisplayedMeals = {};

            // --- MEAL CARD TEMPLATE ---
            const createMealCardHTML = (emoji, type, meal) => {
                if (!meal) {
                    return `<div class="bg-[#F6EDE3] p-4 rounded-[20px] text-center flex flex-col justify-center items-center h-48"><span class="text-4xl">${emoji}</span><h4 class="font-bold mt-1">${type}</h4><p class="text-gray-500 text-sm mt-2">ไม่มีเมนูในหมวดนี้</p></div>`;
                }
                return `<div class="bg-[#F6EDE3] p-4 rounded-[20px] text-center h-48 flex flex-col"><span class="text-4xl">${emoji}</span><h4 class="font-bold mt-1">${type}</h4><p class="text-gray-800 text-sm font-medium mt-2 flex-grow">${meal.name}</p><div class="text-xs text-gray-500 grid grid-cols-2 gap-x-2"><span>🔥 ${meal.calories} kcal</span><span>💪 ${meal.protein}g P</span><span>🌾 ${meal.carbs}g C</span><span>🥑 ${meal.fat}g F</span></div></div>`;
            };
            
            // --- FUNCTIONS ---
            const updateTargetCalories = () => {
                if (!calculatedTDEE) return;
                const goal = goalSelect.value;
                switch (goal) {
                    case 'lose': targetCalories = calculatedTDEE - 400; break;
                    case 'gain': targetCalories = calculatedTDEE + 350; break;
                    case 'maintain': default: targetCalories = calculatedTDEE; break;
                }
            };

            const findNewMeal = (mealType, targetCalories, mealToExclude = null) => {
                const baseCandidates = allMeals.filter(m => m.category === currentMealMode && m.type === mealType);
                if (baseCandidates.length === 0) return null;
                if (baseCandidates.length === 1) return baseCandidates[0];

                const mealsToConsider = mealToExclude ? baseCandidates.filter(m => m.name !== mealToExclude.name) : baseCandidates;
                const finalCandidates = mealsToConsider.length > 0 ? mealsToConsider : baseCandidates;

                const idealRange = finalCandidates.filter(m => m.calories >= targetCalories * 0.9 && m.calories <= targetCalories * 1.1);
                if (idealRange.length > 0) return idealRange[Math.floor(Math.random() * idealRange.length)];
                
                return finalCandidates.reduce((prev, curr) => Math.abs(curr.calories - targetCalories) < Math.abs(prev.calories - targetCalories) ? curr : prev);
            };

            const displaySmartMeals = () => {
                if (!targetCalories || allMeals.length === 0) return;

                const targets = {
                    breakfast: targetCalories * 0.25,
                    lunch: targetCalories * 0.30,
                    dinner: targetCalories * 0.30,
                    snack: targetCalories * 0.15,
                };

                const newMeals = {
                    breakfast: findNewMeal('breakfast', targets.breakfast, currentlyDisplayedMeals.breakfast),
                    lunch: findNewMeal('lunch', targets.lunch, currentlyDisplayedMeals.lunch),
                    dinner: findNewMeal('dinner', targets.dinner, currentlyDisplayedMeals.dinner),
                    snack: findNewMeal('snack', targets.snack, currentlyDisplayedMeals.snack),
                };
                
                currentlyDisplayedMeals = newMeals;
                mealCardsGrid.innerHTML = `${createMealCardHTML('🍳', 'มื้อเช้า', newMeals.breakfast)}${createMealCardHTML('🍲', 'มื้อกลางวัน', newMeals.lunch)}${createMealCardHTML('🥗', 'มื้อเย็น', newMeals.dinner)}${createMealCardHTML('🍌', 'ของว่าง', newMeals.snack)}`;

                const totalCalories = Object.values(newMeals).reduce((sum, meal) => sum + (meal ? meal.calories : 0), 0);
                const goalTextMap = { maintain: 'คงน้ำหนัก', lose: 'ลดน้ำหนัก', gain: 'เพิ่มน้ำหนัก' };
                totalCaloriesText.textContent = `แคลอรี่รวมจากเมนู: ${totalCalories} / เป้าหมาย: ${Math.round(targetCalories)} kcal (${goalTextMap[goalSelect.value]})`;
                
                initialMessage.classList.add('hidden');
                mealCardsGrid.classList.remove('hidden');
                shuffleBtn.classList.remove('hidden');
                totalCaloriesContainer.classList.remove('hidden');
            };
            
            const fetchMeals = async () => {
                loader.classList.remove('hidden');
                initialMessage.classList.add('hidden');
                try {
                    const response = await fetch(MEALS_JSON_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    allMeals = await response.json();
                } catch (e) {
                    console.error("Failed to fetch meal data:", e);
                    errorMessage.textContent = "ไม่สามารถโหลดข้อมูลอาหารได้ โปรดลองอีกครั้งในภายหลัง";
                    errorMessage.classList.remove('hidden');
                } finally {
                    loader.classList.add('hidden');
                    initialMessage.classList.remove('hidden');
                }
            };

            const getBmiCategory = (bmi) => {
                if (bmi < 18.5) return '– อยู่ในเกณฑ์น้ำหนักน้อย';
                if (bmi < 23) return '– อยู่ในเกณฑ์สมส่วน';
                if (bmi < 25) return '– อยู่ในเกณฑ์ท้วม';
                if (bmi < 30) return '– อยู่ในเกณฑ์โรคอ้วนระดับ 1';
                return '– อยู่ในเกณฑ์โรคอ้วนระดับ 2';
            };

            // --- EVENT LISTENERS ---
            calcForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const gender = document.getElementById('gender').value;
                const age = parseInt(document.getElementById('age').value);
                const weight = parseFloat(document.getElementById('weight').value);
                const height = parseFloat(document.getElementById('height').value);
                const activity = parseFloat(document.getElementById('activity').value);

                if (isNaN(age) || isNaN(weight) || isNaN(height) || age <= 0 || weight <= 0 || height <= 0) {
                    alert('กรุณากรอกข้อมูลให้ถูกต้อง');
                    return;
                }
                
                const heightInMeters = height / 100;
                const bmi = weight / (heightInMeters * heightInMeters);
                let bmr = (gender === 'male') 
                    ? (10 * weight + 6.25 * height - 5 * age + 5)
                    : (10 * weight + 6.25 * height - 5 * age - 161);
                
                calculatedTDEE = bmr * activity;
                goalSelect.value = 'maintain';
                updateTargetCalories();

                bmiResultEl.innerHTML = `<strong>BMI:</strong> ${bmi.toFixed(1)} ${getBmiCategory(bmi)}`;
                bmrResultEl.innerHTML = `<strong>BMR:</strong> ${Math.round(bmr)} kcal/วัน`;
                tdeeResultEl.innerHTML = `<strong>TDEE:</strong> ${Math.round(calculatedTDEE)} kcal/วัน`;
                
                resultsContainer.classList.remove('hidden');
                goalContainer.classList.remove('hidden');
                currentlyDisplayedMeals = {};
                displaySmartMeals();
            });
            
            goalSelect.addEventListener('change', () => {
                updateTargetCalories();
                currentlyDisplayedMeals = {};
                displaySmartMeals();
            });

            modeHealthyBtn.addEventListener('click', () => {
                if (currentMealMode === 'healthy') return;
                currentMealMode = 'healthy';
                modeHealthyBtn.classList.add('active-mode');
                modeCleanBtn.classList.remove('active-mode');
                modeCleanBtn.classList.add('text-gray-600');
                currentlyDisplayedMeals = {};
                displaySmartMeals();
            });

            modeCleanBtn.addEventListener('click', () => {
                if (currentMealMode === 'clean') return;
                currentMealMode = 'clean';
                modeCleanBtn.classList.add('active-mode');
                modeHealthyBtn.classList.remove('active-mode');
                modeHealthyBtn.classList.add('text-gray-600');
                currentlyDisplayedMeals = {};
                displaySmartMeals();
            });
            
            shuffleBtn.addEventListener('click', displaySmartMeals);

            // --- INITIALIZATION ---
            fetchMeals();
        });
    </script>
</body>
</html>

